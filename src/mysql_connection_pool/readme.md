# 数据库连接池概述

为了提高数据库（关系型数据库）的访问瓶颈，除了在服务器端增加缓存服务器（例如redis）缓存常用的数据之外，还可以增加连接池，来提高数据库服务器的访问效率

一般来说，对于数据库操作都是在访问数据库的时候创建连接，访问完毕断开连接。但是如果在高并发情况下，有些需要频繁处理的操作就会消耗很多的资源和时间，比如：

1. 建立通信连接的 TCP 三次握手

2. 数据库服务器的连接认证

3. 数据库服务器关闭连接时的资源回收

4. 断开通信连接的 TCP 四次挥手

**使用数据库连接池可以减少这一部分的性能损耗**

# 数据库连接池的设计思路

1. 连接池只需要一个实例，所以连接池类应该是一个单例模式的类

2. 所有的数据库连接应该维护到一个安全的队列中
    - 使用队列的目的是方便连接的添加和删除
    - 所谓的安全指的是线程安全，也就是说需要使用互斥锁来保护队列数据的读写

3. 在需要的时候可以从连接池中得到一个或多个可用的数据库连接
    - 如果有可用连接，直接取出
    - 如果没有可用连接，阻塞等待一定时长然后再重试

4. 如果队列中没有多余的可用连接，需要动态的创建新连接

5. 如果队列中空闲的连接太多，需要动态的销毁一部分

6. 数据库操作完毕，需要将连接归还到连接池中

## 细节分析

1. 连接池连接的动态创建和销毁：分别交给一个单独的线程处理

2. 数据库连接的添加和归还：这是一个典型的生产者和消费者模型
    - 消费者：需要访问数据库的线程，数据库连接被取出（消费）
    - 生产者：专门负责创建数据库连接的线程
    - 处理生产者和消费者模型需要使用条件变量阻塞线程

3. 设置最小连接数目（连接池的默认连接数量，避免空闲时无限制地销毁连接）以及总的最大连接数目（避免无限制地动态创建连接）
    - 如果不够就动态创建
    - 如果太多就动态销毁

4. 连接超时时间：消费者无法获取可用连接时，阻塞等待的时间长度

5. 最大空闲时间：创建出的数据库连接在指定时间长度内若一直未被使用，就需要销毁



MysqlConnection 为 C 的 Mysql API接口的封装类
MysqlConnectionPool 为数据库连接池类

TODO: json解析器模块